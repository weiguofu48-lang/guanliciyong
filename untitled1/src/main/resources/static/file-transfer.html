<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件传输 - 企业管理系统</title>
    <link rel="stylesheet" href="/untitled1/static/css/style.css">
    <style>
        .file-transfer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .file-transfer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .file-transfer-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
            border: 2px solid #007bff;
            min-width: 200px;
            text-align: center;
        }
        
        .file-input-wrapper:hover {
            background: #0056b3;
            border-color: #0056b3;
        }
        
        .file-input-wrapper:active {
            background: #004085;
            border-color: #004085;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .upload-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        
        .upload-button:hover {
            background: #218838;
        }
        
        .upload-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .file-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }
        
        .file-item:hover {
            background: #f8f9fa;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            background: #007bff;
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .file-details {
            font-size: 14px;
            color: #666;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        .download-button {
            background: #007bff;
            color: white;
        }
        
        .download-button:hover {
            background: #0056b3;
        }
        
        .delete-button {
            background: #dc3545;
            color: white;
        }
        
        .delete-button:hover {
            background: #c82333;
        }
        
        .mark-received-button {
            background: #28a745;
            color: white;
        }
        
        .mark-received-button:hover {
            background: #218838;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-sent {
            background: #d4edda;
            color: #155724;
        }
        
        .status-received {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.info {
            background: #007bff;
        }
    </style>
</head>
<body>
    <div class="file-transfer-container">
        <div class="file-transfer-header">
            <h1>文件传输</h1>
            <div>
                <span id="unread-count" class="status-badge status-pending">0 个未读文件</span>
            </div>
        </div>
        
        <div class="file-transfer-tabs">
            <button class="tab-button active" onclick="switchTab('upload')">上传文件</button>
            <button class="tab-button" onclick="switchTab('sent')">已发送</button>
            <button class="tab-button" onclick="switchTab('received')">已接收</button>
            <button class="tab-button" onclick="switchTab('all')">全部记录</button>
        </div>
        
        <!-- 上传文件标签页 -->
        <div id="upload-tab" class="tab-content active">
            <div class="upload-section">
                <h3>上传文件</h3>
                <form class="upload-form" id="uploadForm">
                    <div class="form-group">
                        <label for="fileInput">选择文件</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="fileInput" required>
                            <span>点击选择文件</span>
                        </div>
                        <div class="progress-bar" id="progressBar" style="display: none;">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="receiverSelect">接收者</label>
                        <select id="receiverSelect" required>
                            <option value="">请选择接收者</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="messageInput">备注信息</label>
                        <textarea id="messageInput" placeholder="请输入备注信息（可选）"></textarea>
                    </div>
                    
                    <button type="submit" class="upload-button" id="uploadButton">
                        上传文件
                    </button>
                </form>
            </div>
        </div>
        
        <!-- 已发送文件标签页 -->
        <div id="sent-tab" class="tab-content">
            <div class="file-list" id="sentFileList">
                <div class="empty-state">
                    <i>📤</i>
                    <p>暂无已发送的文件</p>
                </div>
            </div>
        </div>
        
        <!-- 已接收文件标签页 -->
        <div id="received-tab" class="tab-content">
            <div class="file-list" id="receivedFileList">
                <div class="empty-state">
                    <i>📥</i>
                    <p>暂无已接收的文件</p>
                </div>
            </div>
        </div>
        
        <!-- 全部记录标签页 -->
        <div id="all-tab" class="tab-content">
            <div class="file-list" id="allFileList">
                <div class="empty-state">
                    <i>📋</i>
                    <p>暂无文件传输记录</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentUser = null;
        let users = [];
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentUser();
            loadUsers();
            setupEventListeners();
            // 在用户信息加载完成后加载未读数量
            loadUnreadCount();
        });
        
        // 加载当前用户信息
        function loadCurrentUser() {
            // 从localStorage获取当前用户信息
            const userStr = localStorage.getItem('currentUser');
            console.log('从localStorage获取的用户信息:', userStr);
            
            if (userStr) {
                try {
                    currentUser = JSON.parse(userStr);
                    console.log('解析后的用户信息:', currentUser);
                } catch (e) {
                    console.error('解析用户信息失败:', e);
                    currentUser = null;
                }
            }
            
            // 如果没有有效的用户信息，使用默认用户
            if (!currentUser || !currentUser.id) {
                console.log('使用默认用户信息');
                currentUser = {
                    id: 1,
                    username: 'admin',
                    realName: '系统管理员'
                };
            }
            
            console.log('最终用户信息:', currentUser);
        }
        
        // 加载用户列表
        async function loadUsers() {
            try {
                const response = await fetch('/untitled1/api/users');
                if (response.ok) {
                    users = await response.json();
                    populateReceiverSelect();
                } else {
                    showNotification('加载用户列表失败', 'error');
                }
            } catch (error) {
                console.error('加载用户列表失败:', error);
                showNotification('加载用户列表失败', 'error');
            }
        }
        
        // 填充接收者选择框
        function populateReceiverSelect() {
            const select = document.getElementById('receiverSelect');
            select.innerHTML = '<option value="">请选择接收者</option>';
            
            users.forEach(user => {
                if (user.id !== currentUser.id) {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.realName} (${user.username})`;
                    select.appendChild(option);
                }
            });
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 文件上传表单提交
            document.getElementById('uploadForm').addEventListener('submit', handleFileUpload);
            
            // 文件输入变化
            document.getElementById('fileInput').addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const wrapper = this.parentElement;
                    wrapper.querySelector('span').textContent = file.name;
                }
            });
            
            // 为文件输入包装器添加点击事件
            document.querySelector('.file-input-wrapper').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });
        }
        
        // 处理文件上传
        async function handleFileUpload(event) {
            event.preventDefault();
            
            // 检查用户信息是否有效
            if (!currentUser || !currentUser.id) {
                showNotification('用户信息无效，无法上传文件', 'error');
                return;
            }
            
            const fileInput = document.getElementById('fileInput');
            const receiverSelect = document.getElementById('receiverSelect');
            const messageInput = document.getElementById('messageInput');
            const uploadButton = document.getElementById('uploadButton');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            if (!fileInput.files[0]) {
                showNotification('请选择要上传的文件', 'error');
                return;
            }
            
            if (!receiverSelect.value) {
                showNotification('请选择接收者', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('senderId', currentUser.id);
            formData.append('receiverId', receiverSelect.value);
            formData.append('message', messageInput.value);
            
            uploadButton.disabled = true;
            progressBar.style.display = 'block';
            
            try {
                const response = await fetch('/untitled1/api/file-transfer/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('文件上传成功', 'success');
                    fileInput.value = '';
                    messageInput.value = '';
                    receiverSelect.value = '';
                    document.querySelector('.file-input-wrapper span').textContent = '点击选择文件';
                    
                    // 刷新文件列表
                    loadSentFiles();
                    loadUnreadCount();
                } else {
                    showNotification('文件上传失败: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('文件上传失败:', error);
                showNotification('文件上传失败', 'error');
            } finally {
                uploadButton.disabled = false;
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
            }
        }
        
        // 切换标签页
        function switchTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有标签按钮的active类
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // 显示选中的标签页内容
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // 激活对应的标签按钮
            event.target.classList.add('active');
            
            // 加载对应的数据
            switch(tabName) {
                case 'sent':
                    loadSentFiles();
                    break;
                case 'received':
                    loadReceivedFiles();
                    break;
                case 'all':
                    loadAllFiles();
                    break;
            }
        }
        
        // 加载已发送文件
        async function loadSentFiles() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error('用户信息无效，无法加载已发送文件');
                    return;
                }
                
                const response = await fetch(`/untitled1/api/file-transfer/sent/${currentUser.id}`);
                if (response.ok) {
                    const result = await response.json();
                    displayFileList('sentFileList', result.data, 'sent');
                } else {
                    showNotification('加载已发送文件失败', 'error');
                }
            } catch (error) {
                console.error('加载已发送文件失败:', error);
                showNotification('加载已发送文件失败', 'error');
            }
        }
        
        // 加载已接收文件
        async function loadReceivedFiles() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error('用户信息无效，无法加载已接收文件');
                    return;
                }
                
                const response = await fetch(`/untitled1/api/file-transfer/received/${currentUser.id}`);
                if (response.ok) {
                    const result = await response.json();
                    displayFileList('receivedFileList', result.data, 'received');
                } else {
                    showNotification('加载已接收文件失败', 'error');
                }
            } catch (error) {
                console.error('加载已接收文件失败:', error);
                showNotification('加载已接收文件失败', 'error');
            }
        }
        
        // 加载所有文件
        async function loadAllFiles() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error('用户信息无效，无法加载所有文件');
                    return;
                }
                
                const response = await fetch(`/untitled1/api/file-transfer/user/${currentUser.id}`);
                if (response.ok) {
                    const result = await response.json();
                    displayFileList('allFileList', result.data, 'all');
                } else {
                    showNotification('加载文件记录失败', 'error');
                }
            } catch (error) {
                console.error('加载文件记录失败:', error);
                showNotification('加载文件记录失败', 'error');
            }
        }
        
        // 加载未读文件数量
        async function loadUnreadCount() {
            try {
                // 检查用户信息是否有效
                if (!currentUser || !currentUser.id) {
                    console.error('用户信息无效，无法加载未读文件数量');
                    return;
                }
                
                console.log('正在加载未读文件数量，用户ID:', currentUser.id);
                const response = await fetch(`/untitled1/api/file-transfer/unread-count/${currentUser.id}`);
                
                if (response.ok) {
                    const result = await response.json();
                    const count = result.data;
                    const countElement = document.getElementById('unread-count');
                    
                    if (countElement) {
                        if (count > 0) {
                            countElement.textContent = `${count} 个未读文件`;
                            countElement.className = 'status-badge status-pending';
                        } else {
                            countElement.textContent = '0 个未读文件';
                            countElement.className = 'status-badge status-received';
                        }
                    }
                } else {
                    console.error('加载未读文件数量失败，响应状态:', response.status);
                }
            } catch (error) {
                console.error('加载未读文件数量失败:', error);
            }
        }
        
        // 显示文件列表
        function displayFileList(containerId, files, type) {
            const container = document.getElementById(containerId);
            
            if (!files || files.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i>📁</i>
                        <p>暂无文件记录</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = files.map(file => createFileItem(file, type)).join('');
        }
        
        // 创建文件项
        function createFileItem(file, type) {
            const isSender = file.sender.id === currentUser.id;
            const isReceiver = file.receiver.id === currentUser.id;
            const canDownload = isSender || isReceiver;
            const canDelete = isSender || isReceiver;
            const canMarkReceived = isReceiver && file.status === 'SENT';
            
            return `
                <div class="file-item">
                    <div class="file-icon">📄</div>
                    <div class="file-info">
                        <div class="file-name">${file.originalFileName}</div>
                        <div class="file-details">
                            ${isSender ? '发送给' : '来自'} ${isSender ? file.receiver.realName : file.sender.realName} | 
                            大小: ${formatFileSize(file.fileSize)} | 
                            时间: ${formatDateTime(file.createdAt)} |
                            <span class="status-badge status-${file.status.toLowerCase()}">${getStatusText(file.status)}</span>
                        </div>
                        ${file.message ? `<div style="margin-top: 5px; color: #666; font-style: italic;">"${file.message}"</div>` : ''}
                    </div>
                    <div class="file-actions">
                        ${canDownload ? `<button class="action-button download-button" onclick="downloadFile(${file.id})">下载</button>` : ''}
                        ${canMarkReceived ? `<button class="action-button mark-received-button" onclick="markAsReceived(${file.id})">标记已接收</button>` : ''}
                        ${canDelete ? `<button class="action-button delete-button" onclick="deleteFile(${file.id})">删除</button>` : ''}
                    </div>
                </div>
            `;
        }
        
        // 下载文件
        async function downloadFile(transferId) {
            try {
                const response = await fetch(`/untitled1/api/file-transfer/download/${transferId}?userId=${currentUser.id}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = response.headers.get('Content-Disposition')?.split('filename=')[1] || 'file';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showNotification('文件下载成功', 'success');
                } else {
                    showNotification('文件下载失败', 'error');
                }
            } catch (error) {
                console.error('文件下载失败:', error);
                showNotification('文件下载失败', 'error');
            }
        }
        
        // 标记为已接收
        async function markAsReceived(transferId) {
            try {
                const response = await fetch(`/untitled1/api/file-transfer/mark-received/${transferId}?userId=${currentUser.id}`, {
                    method: 'PUT'
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('文件已标记为已接收', 'success');
                    loadReceivedFiles();
                    loadUnreadCount();
                } else {
                    showNotification('标记失败: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('标记文件为已接收失败:', error);
                showNotification('标记失败', 'error');
            }
        }
        
        // 删除文件
        async function deleteFile(transferId) {
            if (!confirm('确定要删除这个文件传输记录吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`/untitled1/api/file-transfer/${transferId}?userId=${currentUser.id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('文件传输记录已删除', 'success');
                    // 刷新当前标签页
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab.id === 'sent-tab') {
                        loadSentFiles();
                    } else if (activeTab.id === 'received-tab') {
                        loadReceivedFiles();
                    } else if (activeTab.id === 'all-tab') {
                        loadAllFiles();
                    }
                } else {
                    showNotification('删除失败: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('删除文件传输记录失败:', error);
                showNotification('删除失败', 'error');
            }
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 格式化日期时间
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString('zh-CN');
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'PENDING': '待发送',
                'SENT': '已发送',
                'RECEIVED': '已接收',
                'EXPIRED': '已过期',
                'CANCELLED': '已取消'
            };
            return statusMap[status] || status;
        }
        
        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>

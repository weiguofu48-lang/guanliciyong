<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¼ è¾“ - ä¼ä¸šç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/untitled1/static/css/style.css">
    <style>
        .file-transfer-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .file-transfer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .file-transfer-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
            border: 2px solid #007bff;
            min-width: 200px;
            text-align: center;
        }
        
        .file-input-wrapper:hover {
            background: #0056b3;
            border-color: #0056b3;
        }
        
        .file-input-wrapper:active {
            background: #004085;
            border-color: #004085;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .upload-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        
        .upload-button:hover {
            background: #218838;
        }
        
        .upload-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .file-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }
        
        .file-item:hover {
            background: #f8f9fa;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            background: #007bff;
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .file-details {
            font-size: 14px;
            color: #666;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        .download-button {
            background: #007bff;
            color: white;
        }
        
        .download-button:hover {
            background: #0056b3;
        }
        
        .delete-button {
            background: #dc3545;
            color: white;
        }
        
        .delete-button:hover {
            background: #c82333;
        }
        
        .mark-received-button {
            background: #28a745;
            color: white;
        }
        
        .mark-received-button:hover {
            background: #218838;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-sent {
            background: #d4edda;
            color: #155724;
        }
        
        .status-received {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.info {
            background: #007bff;
        }
    </style>
</head>
<body>
    <div class="file-transfer-container">
        <div class="file-transfer-header">
            <h1>æ–‡ä»¶ä¼ è¾“</h1>
            <div>
                <span id="unread-count" class="status-badge status-pending">0 ä¸ªæœªè¯»æ–‡ä»¶</span>
            </div>
        </div>
        
        <div class="file-transfer-tabs">
            <button class="tab-button active" onclick="switchTab('upload')">ä¸Šä¼ æ–‡ä»¶</button>
            <button class="tab-button" onclick="switchTab('sent')">å·²å‘é€</button>
            <button class="tab-button" onclick="switchTab('received')">å·²æ¥æ”¶</button>
            <button class="tab-button" onclick="switchTab('all')">å…¨éƒ¨è®°å½•</button>
        </div>
        
        <!-- ä¸Šä¼ æ–‡ä»¶æ ‡ç­¾é¡µ -->
        <div id="upload-tab" class="tab-content active">
            <div class="upload-section">
                <h3>ä¸Šä¼ æ–‡ä»¶</h3>
                <form class="upload-form" id="uploadForm">
                    <div class="form-group">
                        <label for="fileInput">é€‰æ‹©æ–‡ä»¶</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="fileInput" required>
                            <span>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span>
                        </div>
                        <div class="progress-bar" id="progressBar" style="display: none;">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="receiverSelect">æ¥æ”¶è€…</label>
                        <select id="receiverSelect" required>
                            <option value="">è¯·é€‰æ‹©æ¥æ”¶è€…</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="messageInput">å¤‡æ³¨ä¿¡æ¯</label>
                        <textarea id="messageInput" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>
                    
                    <button type="submit" class="upload-button" id="uploadButton">
                        ä¸Šä¼ æ–‡ä»¶
                    </button>
                </form>
            </div>
        </div>
        
        <!-- å·²å‘é€æ–‡ä»¶æ ‡ç­¾é¡µ -->
        <div id="sent-tab" class="tab-content">
            <div class="file-list" id="sentFileList">
                <div class="empty-state">
                    <i>ğŸ“¤</i>
                    <p>æš‚æ— å·²å‘é€çš„æ–‡ä»¶</p>
                </div>
            </div>
        </div>
        
        <!-- å·²æ¥æ”¶æ–‡ä»¶æ ‡ç­¾é¡µ -->
        <div id="received-tab" class="tab-content">
            <div class="file-list" id="receivedFileList">
                <div class="empty-state">
                    <i>ğŸ“¥</i>
                    <p>æš‚æ— å·²æ¥æ”¶çš„æ–‡ä»¶</p>
                </div>
            </div>
        </div>
        
        <!-- å…¨éƒ¨è®°å½•æ ‡ç­¾é¡µ -->
        <div id="all-tab" class="tab-content">
            <div class="file-list" id="allFileList">
                <div class="empty-state">
                    <i>ğŸ“‹</i>
                    <p>æš‚æ— æ–‡ä»¶ä¼ è¾“è®°å½•</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentUser = null;
        let users = [];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentUser();
            loadUsers();
            setupEventListeners();
            // åœ¨ç”¨æˆ·ä¿¡æ¯åŠ è½½å®ŒæˆååŠ è½½æœªè¯»æ•°é‡
            loadUnreadCount();
        });
        
        // åŠ è½½å½“å‰ç”¨æˆ·ä¿¡æ¯
        function loadCurrentUser() {
            // ä»localStorageè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            const userStr = localStorage.getItem('currentUser');
            console.log('ä»localStorageè·å–çš„ç”¨æˆ·ä¿¡æ¯:', userStr);
            
            if (userStr) {
                try {
                    currentUser = JSON.parse(userStr);
                    console.log('è§£æåçš„ç”¨æˆ·ä¿¡æ¯:', currentUser);
                } catch (e) {
                    console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
                    currentUser = null;
                }
            }
            
            // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ç”¨æˆ·
            if (!currentUser || !currentUser.id) {
                console.log('ä½¿ç”¨é»˜è®¤ç”¨æˆ·ä¿¡æ¯');
                currentUser = {
                    id: 1,
                    username: 'admin',
                    realName: 'ç³»ç»Ÿç®¡ç†å‘˜'
                };
            }
            
            console.log('æœ€ç»ˆç”¨æˆ·ä¿¡æ¯:', currentUser);
        }
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            try {
                const response = await fetch('/untitled1/api/users');
                if (response.ok) {
                    users = await response.json();
                    populateReceiverSelect();
                } else {
                    showNotification('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                showNotification('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', 'error');
            }
        }
        
        // å¡«å……æ¥æ”¶è€…é€‰æ‹©æ¡†
        function populateReceiverSelect() {
            const select = document.getElementById('receiverSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©æ¥æ”¶è€…</option>';
            
            users.forEach(user => {
                if (user.id !== currentUser.id) {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.realName} (${user.username})`;
                    select.appendChild(option);
                }
            });
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ è¡¨å•æäº¤
            document.getElementById('uploadForm').addEventListener('submit', handleFileUpload);
            
            // æ–‡ä»¶è¾“å…¥å˜åŒ–
            document.getElementById('fileInput').addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const wrapper = this.parentElement;
                    wrapper.querySelector('span').textContent = file.name;
                }
            });
            
            // ä¸ºæ–‡ä»¶è¾“å…¥åŒ…è£…å™¨æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelector('.file-input-wrapper').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });
        }
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        async function handleFileUpload(event) {
            event.preventDefault();
            
            // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æœ‰æ•ˆ
            if (!currentUser || !currentUser.id) {
                showNotification('ç”¨æˆ·ä¿¡æ¯æ— æ•ˆï¼Œæ— æ³•ä¸Šä¼ æ–‡ä»¶', 'error');
                return;
            }
            
            const fileInput = document.getElementById('fileInput');
            const receiverSelect = document.getElementById('receiverSelect');
            const messageInput = document.getElementById('messageInput');
            const uploadButton = document.getElementById('uploadButton');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            if (!fileInput.files[0]) {
                showNotification('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'error');
                return;
            }
            
            if (!receiverSelect.value) {
                showNotification('è¯·é€‰æ‹©æ¥æ”¶è€…', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('senderId', currentUser.id);
            formData.append('receiverId', receiverSelect.value);
            formData.append('message', messageInput.value);
            
            uploadButton.disabled = true;
            progressBar.style.display = 'block';
            
            try {
                const response = await fetch('/untitled1/api/file-transfer/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ', 'success');
                    fileInput.value = '';
                    messageInput.value = '';
                    receiverSelect.value = '';
                    document.querySelector('.file-input-wrapper span').textContent = 'ç‚¹å‡»é€‰æ‹©æ–‡ä»¶';
                    
                    // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    loadSentFiles();
                    loadUnreadCount();
                } else {
                    showNotification('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                showNotification('æ–‡ä»¶ä¸Šä¼ å¤±è´¥', 'error');
            } finally {
                uploadButton.disabled = false;
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
            }
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„activeç±»
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
            event.target.classList.add('active');
            
            // åŠ è½½å¯¹åº”çš„æ•°æ®
            switch(tabName) {
                case 'sent':
                    loadSentFiles();
                    break;
                case 'received':
                    loadReceivedFiles();
                    break;
                case 'all':
                    loadAllFiles();
                    break;
            }
        }
        
        // åŠ è½½å·²å‘é€æ–‡ä»¶
        async function loadSentFiles() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error('ç”¨æˆ·ä¿¡æ¯æ— æ•ˆï¼Œæ— æ³•åŠ è½½å·²å‘é€æ–‡ä»¶');
                    return;
                }
                
                const response = await fetch(`/untitled1/api/file-transfer/sent/${currentUser.id}`);
                if (response.ok) {
                    const result = await response.json();
                    displayFileList('sentFileList', result.data, 'sent');
                } else {
                    showNotification('åŠ è½½å·²å‘é€æ–‡ä»¶å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½å·²å‘é€æ–‡ä»¶å¤±è´¥:', error);
                showNotification('åŠ è½½å·²å‘é€æ–‡ä»¶å¤±è´¥', 'error');
            }
        }
        
        // åŠ è½½å·²æ¥æ”¶æ–‡ä»¶
        async function loadReceivedFiles() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error('ç”¨æˆ·ä¿¡æ¯æ— æ•ˆï¼Œæ— æ³•åŠ è½½å·²æ¥æ”¶æ–‡ä»¶');
                    return;
                }
                
                const response = await fetch(`/untitled1/api/file-transfer/received/${currentUser.id}`);
                if (response.ok) {
                    const result = await response.json();
                    displayFileList('receivedFileList', result.data, 'received');
                } else {
                    showNotification('åŠ è½½å·²æ¥æ”¶æ–‡ä»¶å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½å·²æ¥æ”¶æ–‡ä»¶å¤±è´¥:', error);
                showNotification('åŠ è½½å·²æ¥æ”¶æ–‡ä»¶å¤±è´¥', 'error');
            }
        }
        
        // åŠ è½½æ‰€æœ‰æ–‡ä»¶
        async function loadAllFiles() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error('ç”¨æˆ·ä¿¡æ¯æ— æ•ˆï¼Œæ— æ³•åŠ è½½æ‰€æœ‰æ–‡ä»¶');
                    return;
                }
                
                const response = await fetch(`/untitled1/api/file-transfer/user/${currentUser.id}`);
                if (response.ok) {
                    const result = await response.json();
                    displayFileList('allFileList', result.data, 'all');
                } else {
                    showNotification('åŠ è½½æ–‡ä»¶è®°å½•å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶è®°å½•å¤±è´¥:', error);
                showNotification('åŠ è½½æ–‡ä»¶è®°å½•å¤±è´¥', 'error');
            }
        }
        
        // åŠ è½½æœªè¯»æ–‡ä»¶æ•°é‡
        async function loadUnreadCount() {
            try {
                // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æœ‰æ•ˆ
                if (!currentUser || !currentUser.id) {
                    console.error('ç”¨æˆ·ä¿¡æ¯æ— æ•ˆï¼Œæ— æ³•åŠ è½½æœªè¯»æ–‡ä»¶æ•°é‡');
                    return;
                }
                
                console.log('æ­£åœ¨åŠ è½½æœªè¯»æ–‡ä»¶æ•°é‡ï¼Œç”¨æˆ·ID:', currentUser.id);
                const response = await fetch(`/untitled1/api/file-transfer/unread-count/${currentUser.id}`);
                
                if (response.ok) {
                    const result = await response.json();
                    const count = result.data;
                    const countElement = document.getElementById('unread-count');
                    
                    if (countElement) {
                        if (count > 0) {
                            countElement.textContent = `${count} ä¸ªæœªè¯»æ–‡ä»¶`;
                            countElement.className = 'status-badge status-pending';
                        } else {
                            countElement.textContent = '0 ä¸ªæœªè¯»æ–‡ä»¶';
                            countElement.className = 'status-badge status-received';
                        }
                    }
                } else {
                    console.error('åŠ è½½æœªè¯»æ–‡ä»¶æ•°é‡å¤±è´¥ï¼Œå“åº”çŠ¶æ€:', response.status);
                }
            } catch (error) {
                console.error('åŠ è½½æœªè¯»æ–‡ä»¶æ•°é‡å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
        function displayFileList(containerId, files, type) {
            const container = document.getElementById(containerId);
            
            if (!files || files.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i>ğŸ“</i>
                        <p>æš‚æ— æ–‡ä»¶è®°å½•</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = files.map(file => createFileItem(file, type)).join('');
        }
        
        // åˆ›å»ºæ–‡ä»¶é¡¹
        function createFileItem(file, type) {
            const isSender = file.sender.id === currentUser.id;
            const isReceiver = file.receiver.id === currentUser.id;
            const canDownload = isSender || isReceiver;
            const canDelete = isSender || isReceiver;
            const canMarkReceived = isReceiver && file.status === 'SENT';
            
            return `
                <div class="file-item">
                    <div class="file-icon">ğŸ“„</div>
                    <div class="file-info">
                        <div class="file-name">${file.originalFileName}</div>
                        <div class="file-details">
                            ${isSender ? 'å‘é€ç»™' : 'æ¥è‡ª'} ${isSender ? file.receiver.realName : file.sender.realName} | 
                            å¤§å°: ${formatFileSize(file.fileSize)} | 
                            æ—¶é—´: ${formatDateTime(file.createdAt)} |
                            <span class="status-badge status-${file.status.toLowerCase()}">${getStatusText(file.status)}</span>
                        </div>
                        ${file.message ? `<div style="margin-top: 5px; color: #666; font-style: italic;">"${file.message}"</div>` : ''}
                    </div>
                    <div class="file-actions">
                        ${canDownload ? `<button class="action-button download-button" onclick="downloadFile(${file.id})">ä¸‹è½½</button>` : ''}
                        ${canMarkReceived ? `<button class="action-button mark-received-button" onclick="markAsReceived(${file.id})">æ ‡è®°å·²æ¥æ”¶</button>` : ''}
                        ${canDelete ? `<button class="action-button delete-button" onclick="deleteFile(${file.id})">åˆ é™¤</button>` : ''}
                    </div>
                </div>
            `;
        }
        
        // ä¸‹è½½æ–‡ä»¶
        async function downloadFile(transferId) {
            try {
                const response = await fetch(`/untitled1/api/file-transfer/download/${transferId}?userId=${currentUser.id}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = response.headers.get('Content-Disposition')?.split('filename=')[1] || 'file';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showNotification('æ–‡ä»¶ä¸‹è½½æˆåŠŸ', 'success');
                } else {
                    showNotification('æ–‡ä»¶ä¸‹è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ–‡ä»¶ä¸‹è½½å¤±è´¥:', error);
                showNotification('æ–‡ä»¶ä¸‹è½½å¤±è´¥', 'error');
            }
        }
        
        // æ ‡è®°ä¸ºå·²æ¥æ”¶
        async function markAsReceived(transferId) {
            try {
                const response = await fetch(`/untitled1/api/file-transfer/mark-received/${transferId}?userId=${currentUser.id}`, {
                    method: 'PUT'
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('æ–‡ä»¶å·²æ ‡è®°ä¸ºå·²æ¥æ”¶', 'success');
                    loadReceivedFiles();
                    loadUnreadCount();
                } else {
                    showNotification('æ ‡è®°å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('æ ‡è®°æ–‡ä»¶ä¸ºå·²æ¥æ”¶å¤±è´¥:', error);
                showNotification('æ ‡è®°å¤±è´¥', 'error');
            }
        }
        
        // åˆ é™¤æ–‡ä»¶
        async function deleteFile(transferId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶ä¼ è¾“è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/untitled1/api/file-transfer/${transferId}?userId=${currentUser.id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('æ–‡ä»¶ä¼ è¾“è®°å½•å·²åˆ é™¤', 'success');
                    // åˆ·æ–°å½“å‰æ ‡ç­¾é¡µ
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab.id === 'sent-tab') {
                        loadSentFiles();
                    } else if (activeTab.id === 'received-tab') {
                        loadReceivedFiles();
                    } else if (activeTab.id === 'all-tab') {
                        loadAllFiles();
                    }
                } else {
                    showNotification('åˆ é™¤å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ–‡ä»¶ä¼ è¾“è®°å½•å¤±è´¥:', error);
                showNotification('åˆ é™¤å¤±è´¥', 'error');
            }
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString('zh-CN');
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'PENDING': 'å¾…å‘é€',
                'SENT': 'å·²å‘é€',
                'RECEIVED': 'å·²æ¥æ”¶',
                'EXPIRED': 'å·²è¿‡æœŸ',
                'CANCELLED': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
